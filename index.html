<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Goals & Gaps Tracker</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="print.css" media="print">
  <style>
    :root{
      --brand:#e5006d;
      --card:#ffffff;
      --bg:#f7f7fb;
      --text:#111;
      --muted:#6b7280;
      --ring:#d1d5db;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif}
    .header{
      padding:8px 0 0;
      display:flex;align-items:center;justify-content:center;
      background:var(--card);
      border-bottom:1px solid #eee;
    }
    .logo{
      display:block;
      height:72px; /* tidy, not too tall */
      max-width:92%;
      object-fit:contain;
      margin:4px auto;
    }
    .wrap{max-width:720px;margin:16px auto;padding:0 16px}
    .card{
      background:var(--card);
      border-radius:18px;
      box-shadow:0 6px 24px rgba(0,0,0,.06);
      padding:16px 16px 20px;
    }
    h1{
      text-align:center;margin:6px 0 2px;
      font-size:30px;line-height:1.1;color:var(--brand);font-weight:800;
    }
    h2{margin:0 0 12px;text-align:center;font-size:22px}
    label{display:block;font-weight:700;margin:14px 0 6px}
    select{
      width:100%;padding:14px 12px;border-radius:12px;border:1px solid var(--ring);
      font-size:18px;background:#f8fafc;
    }
    .btn{
      margin:18px auto 6px;display:block;width:min(520px,100%);padding:16px 14px;
      border:none;border-radius:16px;background:var(--brand);color:#fff;
      font-size:20px;font-weight:800;opacity:.45;pointer-events:none;
    }
    .btn.enabled{opacity:1;pointer-events:auto;cursor:pointer}
    .hint{color:var(--muted);text-align:center;margin:6px 0 0}
  </style>
</head>
<body>
  <header class="header">
    <img class="logo" alt="Connectivity Source" src="/logo-256.png"
      onerror="this.onerror=null;this.src='logo-256.png';">
  </header>

  <main class="wrap">
    <section class="card">
      <h1>Goals &amp; Gaps Tracker</h1>
      <h2>Select Your Store</h2>

      <label for="area">Area</label>
      <select id="area"><option value="">Select Area</option></select>

      <label for="region">Region</label>
      <select id="region" disabled><option value="">Select Region</option></select>

      <label for="district">District</label>
      <select id="district" disabled><option value="">Select District</option></select>

      <label for="store">Store</label>
      <select id="store" disabled><option value="">Select Store</option></select>

      <button id="goBtn" class="btn" type="button">DORT â†’</button>
      <p class="hint">Your selections are saved on this device.</p>
    </section>
  </main>

<script>
(async function(){
  // Try both likely paths for locations.json, whichever succeeds first.
  async function fetchFirst(paths){
    for (const p of paths){
      try{
        const res = await fetch(p, {cache:'no-store'});
        if(!res.ok) continue;
        const json = await res.json();
        return {json, path:p};
      }catch(e){/* try the next path */}
    }
    throw new Error('locations.json not found in any known path.');
  }

  function normalize(records){
    // Accept either flat list of stores with Area/Region/District/StoreName keys
    // or a pre-grouped structure. We normalize to a flat list of {area,region,district,store}
    if (Array.isArray(records) && records.length && typeof records[0] === 'object'){
      const r = records[0];
      const keys = Object.keys(r).reduce((acc,k)=>{acc[k.toLowerCase()]=k;return acc;},{});
      const areaK = keys.area || keys['area '] || 'Area';
      const regionK = keys.region || 'Region';
      const districtK = keys.district || 'District';
      const storeK = keys.store || keys.storename || 'Store';
      return records.map(row => ({
        area: String(row[areaK] ?? row['Area'] ?? '').trim(),
        region: String(row[regionK] ?? row['Region'] ?? '').trim(),
        district: String(row[districtK] ?? row['District'] ?? '').trim(),
        store: String(row[storeK] ?? row['Store'] ?? row['Store Name'] ?? '').trim()
      })).filter(x => x.area && x.region && x.district && x.store);
    }
    return [];
  }

  let data;
  try{
    const {json, path} = await fetchFirst([
      './locations.json',
      './app/locations.json',
      '/app/locations.json',
      '/locations.json'
    ]);
    data = normalize(json);
    if(!data.length) throw new Error('locations.json loaded but format was unexpected.');
  }catch(err){
    alert('Could not load store list. Please make sure "locations.json" exists in /app or / with Area/Region/District/Store fields.');
    console.error(err);
    return;
  }

  // Build cascading selects
  const areaSel = document.getElementById('area');
  const regionSel = document.getElementById('region');
  const districtSel = document.getElementById('district');
  const storeSel = document.getElementById('store');
  const goBtn = document.getElementById('goBtn');

  const uniq = (arr) => [...new Set(arr)].sort((a,b)=> a.localeCompare(b,'en',{numeric:true}));

  function fill(select, items, placeholder){
    select.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = placeholder;
    select.appendChild(opt0);
    items.forEach(v => {
      const o = document.createElement('option');
      o.value = v; o.textContent = v;
      select.appendChild(o);
    });
    select.disabled = items.length === 0;
  }

  // First level: areas
  fill(areaSel, uniq(data.map(x=>x.area)), 'Select Area');

  areaSel.addEventListener('change', () => {
    const area = areaSel.value;
    const regions = area ? uniq(data.filter(x=>x.area===area).map(x=>x.region)) : [];
    fill(regionSel, regions, 'Select Region');
    fill(districtSel, [], 'Select District');
    fill(storeSel, [], 'Select Store');
    goBtn.classList.remove('enabled');
  });

  regionSel.addEventListener('change', () => {
    const area = areaSel.value;
    const region = regionSel.value;
    const districts = (area && region) ?
      uniq(data.filter(x=>x.area===area && x.region===region).map(x=>x.district)) : [];
    fill(districtSel, districts, 'Select District');
    fill(storeSel, [], 'Select Store');
    goBtn.classList.remove('enabled');
  });

  districtSel.addEventListener('change', () => {
    const area = areaSel.value;
    const region = regionSel.value;
    const district = districtSel.value;
    const stores = (area && region && district) ?
      uniq(data.filter(x=>x.area===area && x.region===region && x.district===district).map(x=>x.store)) : [];
    fill(storeSel, stores, 'Select Store');
    goBtn.classList.remove('enabled');
  });

  storeSel.addEventListener('change', () => {
    if (storeSel.value){
      goBtn.classList.add('enabled');
    }else{
      goBtn.classList.remove('enabled');
    }
  });

  goBtn.addEventListener('click', () => {
    if (!storeSel.value) return;
    const sel = {
      area: areaSel.value,
      region: regionSel.value,
      district: districtSel.value,
      store: storeSel.value
    };
    try{ localStorage.setItem('ggt_selection', JSON.stringify(sel)); }catch(e){}
    // Route to DORT
    const here = window.location.pathname.toLowerCase();
    const to = here.endsWith('/app/index.html') || here.endsWith('/app/')
      ? '/app/dort.html'
      : (here.endsWith('/index.html') || here === '/' ? '/app/dort.html' : 'dort.html');
    window.location.href = to;
  });
})();
</script>
</body>
</html>
