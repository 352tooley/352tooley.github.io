<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Goals & Gaps Tracker</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/x-icon" href="/app/icons/favicon.ico">
<link rel="apple-touch-icon" href="/app/icons/apple-touch-icon.png">
<meta name="theme-color" content="#e6007e">
<style>
  :root {
    --brand:#e6007e;
    --card:#ffffff;
    --soft:#f6f7fb;
    --text:#121212;
    --muted:#6b7280;
  }
  html,body { margin:0; padding:0; background:#f5f5f7; color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Helvetica Neue",Arial,sans-serif; }
  .header { display:flex; align-items:center; justify-content:center; background:#fff; }
  .logo-wrap {
    width:100%;
    max-width:720px;
    padding:12px 16px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:visible;
  }
  /* Use contain so the full logo is visible; limit max-height to keep header compact */
  .logo { display:block; width:auto; height:auto; max-height:120px; object-fit:contain; object-position:center; border-radius:12px; }
  .card { max-width:720px; margin:12px auto 24px; background:var(--card); border-radius:18px; box-shadow:0 10px 24px rgba(0,0,0,.08); padding:22px; }
  h1 { margin:6px 0 10px; font-size:clamp(22px,4.6vw,32px); color:var(--brand); text-align:center; }
  h2 { margin:0 0 18px; font-size:clamp(18px,4vw,24px); text-align:center; }
  label { display:block; font-weight:700; margin:14px 0 8px; }
  select { width:100%; font-size:17px; padding:14px 14px; border-radius:14px; border:1px solid #e5e7eb; background:linear-gradient(#fff,#f8fafc); }
  select:disabled { color:#9ca3af; }
  .btn { margin:20px 0 8px; width:100%; display:block; text-align:center; padding:16px 18px; border:none; border-radius:16px; font-weight:800; font-size:20px; background:#ff2b86; color:#fff; opacity:.45; pointer-events:none; }
  /* Allow clicks when enabled */
  .btn.enabled { cursor:pointer; opacity:1; box-shadow:0 12px 18px rgba(255,43,134,.25); pointer-events:auto; }
  .note { text-align:center; color:var(--muted); margin-top:2px; }
</style>
</head>
<body>
  <header class="header">
    <div class="logo-wrap">
      <img id="siteLogo" class="logo" alt="Connectivity Source" src="/logo-256.png">
    </div>
  </header>

  <main class="card">
    <h1>Goals & Gaps Tracker</h1>
    <h2>Select Your Store</h2>

    <label for="area">Area</label>
    <select id="area"><option value="">Select Area</option></select>

    <label for="region">Region</label>
    <select id="region" disabled><option value="">Select Region</option></select>

    <label for="district">District</label>
    <select id="district" disabled><option value="">Select District</option></select>

    <label for="store">Store</label>
    <select id="store" disabled><option value="">Select Store</option></select>

    <button id="goBtn" class="btn" disabled type="button">DORT â†’</button>
    <div class="note">Your selections are saved on this device.</div>
  </main>

<script>
(async function() {
  console.log('[ggt] initializing index');
  const logoImg = document.getElementById('siteLogo');

  // Try to extract inline logo from /app/dort.html (use as header), otherwise keep fallback
  try {
    const res = await fetch('/app/dort.html', {cache: 'no-store'});
    if (res.ok) {
      const text = await res.text();
      const m = text.match(/data:image\/[a-zA-Z0-9.+-]+;base64,[A-Za-z0-9+/=]+/);
      if (m && m[0]) {
        logoImg.src = m[0];
        console.log('[ggt] extracted inline logo from /app/dort.html');
      }
    } else {
      console.warn('[ggt] fetch /app/dort.html returned', res.status);
    }
  } catch (e) {
    console.warn('[ggt] could not fetch /app/dort.html to extract logo:', e);
  }

  const areaSel = document.getElementById('area');
  const regionSel = document.getElementById('region');
  const districtSel = document.getElementById('district');
  const storeSel = document.getElementById('store');
  const goBtn = document.getElementById('goBtn');

  function uniq(arr) { return [...new Set(arr.filter(Boolean))].sort(); }
  function pick(obj, keys) { for (const k of keys) if (k in obj) return obj[k]; return ''; }

  // Load and normalize locations
  let raw = null;
  try {
    const res2 = await fetch('/app/locations.json', { cache: 'no-store' });
    if (!res2.ok) throw new Error('HTTP '+res2.status);
    raw = await res2.json();
    console.log('[ggt] loaded /app/locations.json');
  } catch (e) {
    console.error('[ggt] could not load /app/locations.json:', e);
    alert('Could not load store list. Please make sure "/app/locations.json" exists and is accessible.');
    return;
  }

  let data = [];
  try {
    if (Array.isArray(raw)) {
      data = raw.map(r => ({
        area:  pick(r, ['area','Area','AREA']),
        region:pick(r, ['region','Region','REGION']),
        district:pick(r, ['district','District','DISTRICT']),
        store: pick(r, ['store','Store','STORE','store_name','Store Name'])
      })).filter(row => row.area && row.region && row.district && row.store);
    } else if (raw && typeof raw === 'object') {
      for (const areaKey of Object.keys(raw)) {
        const areaVal = raw[areaKey];
        if (!areaVal || typeof areaVal !== 'object') continue;
        for (const regionKey of Object.keys(areaVal)) {
          const regionVal = areaVal[regionKey];
          if (!regionVal) continue;
          if (Array.isArray(regionVal)) {
            for (const storeName of regionVal) {
              data.push({ area: areaKey, region: regionKey, district: regionKey, store: String(storeName) });
            }
          } else if (typeof regionVal === 'object') {
            for (const districtKey of Object.keys(regionVal)) {
              const stores = regionVal[districtKey];
              if (!Array.isArray(stores)) continue;
              for (const storeName of stores) {
                data.push({ area: areaKey, region: regionKey, district: districtKey, store: String(storeName) });
              }
            }
          }
        }
      }
    }
  } catch (e) {
    console.error('[ggt] error normalizing locations.json:', e, raw);
  }

  if (!data.length) {
    console.error('[ggt] no valid entries after normalization', data, raw);
    alert('No valid store entries found in /app/locations.json after normalization.');
    return;
  }

  // populate area select
  uniq(data.map(r => r.area)).forEach(a => {
    const o = document.createElement('option'); o.value=o.textContent=a; areaSel.appendChild(o);
  });

  // helper to update button UI
  function updateButtonState() {
    const ok = !!storeSel.value;
    goBtn.disabled = !ok;
    if (ok) goBtn.classList.add('enabled'); else goBtn.classList.remove('enabled');
  }

  areaSel.addEventListener('change', () => {
    regionSel.innerHTML = '<option value="">Select Region</option>';
    districtSel.innerHTML = '<option value="">Select District</option>';
    storeSel.innerHTML = '<option value="">Select Store</option>';
    regionSel.disabled = districtSel.disabled = storeSel.disabled = true;
    updateButtonState();

    const regs = uniq(data.filter(r => r.area===areaSel.value).map(r => r.region));
    regs.forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; regionSel.appendChild(o); });
    regionSel.disabled = regs.length===0;
  });

  regionSel.addEventListener('change', () => {
    districtSel.innerHTML = '<option value="">Select District</option>';
    storeSel.innerHTML = '<option value="">Select Store</option>';
    districtSel.disabled = storeSel.disabled = true;
    updateButtonState();

    const dists = uniq(data.filter(r => r.area===areaSel.value && r.region===regionSel.value).map(r => r.district));
    dists.forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; districtSel.appendChild(o); });
    districtSel.disabled = dists.length===0;
  });

  districtSel.addEventListener('change', () => {
    storeSel.innerHTML = '<option value="">Select Store</option>';
    storeSel.disabled = true;
    updateButtonState();

    const stores = uniq(data.filter(r => r.area===areaSel.value && r.region===regionSel.value && r.district===districtSel.value).map(r => r.store));
    stores.forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; storeSel.appendChild(o); });
    storeSel.disabled = stores.length===0;
  });

  storeSel.addEventListener('change', updateButtonState);

  // Attach click handler with debug logging and use assign() for navigation.
  try {
    goBtn.addEventListener('click', () => {
      console.log('[ggt] goBtn clicked', {
        area: areaSel.value,
        region: regionSel.value,
        district: districtSel.value,
        store: storeSel.value
      });
      if (!storeSel.value) return;
      const sel = { area: areaSel.value, region: regionSel.value, district: districtSel.value, store: storeSel.value };
      try { localStorage.setItem('ggt_selection', JSON.stringify(sel)); } catch(e) { console.warn('[ggt] localStorage set failed', e); }
      try { localStorage.setItem('ggt.area', sel.area); localStorage.setItem('ggt.region', sel.region); localStorage.setItem('ggt.district', sel.district); localStorage.setItem('ggt.store', sel.store); } catch(e) {}
      // use assign to navigate (clearly visible in logs)
      window.location.assign('/app/dort.html');
    });
    console.log('[ggt] click handler attached to goBtn');
  } catch (e) {
    console.error('[ggt] failed to attach click handler to goBtn', e);
  }

  console.log('[ggt] initialization complete');
})();
</script>
</body>
</html>
