<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Goals & Gaps Tracker</title>
<link rel="manifest" href="/manifest.json">
<style>
  :root {
    --brand:#e6007e;
    --card:#ffffff;
    --soft:#f6f7fb;
    --text:#121212;
    --muted:#6b7280;
  }
  html,body { margin:0; padding:0; background:#f5f5f7; color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Helvetica Neue",Arial,sans-serif; }
  .header { display:flex; align-items:center; justify-content:center; background:#fff; }
  .logo-wrap { width:100%; max-width:720px; padding:12px 16px 0; }
  .logo { display:block; width:100%; height:auto; aspect-ratio: 11 / 3; object-fit: cover; object-position:center; border-radius:12px; }
  .card { max-width:720px; margin:12px auto 24px; background:var(--card); border-radius:18px; box-shadow:0 10px 24px rgba(0,0,0,.08); padding:22px; }
  h1 { margin:6px 0 10px; font-size:clamp(22px,4.6vw,32px); color:var(--brand); text-align:center; }
  h2 { margin:0 0 18px; font-size:clamp(18px,4vw,24px); text-align:center; }
  label { display:block; font-weight:700; margin:14px 0 8px; }
  select { width:100%; font-size:17px; padding:14px 14px; border-radius:14px; border:1px solid #e5e7eb; background:linear-gradient(#fff,#f8fafc); }
  select:disabled { color:#9ca3af; }
  .btn { margin:20px 0 8px; width:100%; display:block; text-align:center; padding:16px 18px; border:none; border-radius:16px; font-weight:800; font-size:20px; background:#ff2b86; color:#fff; opacity:.45; pointer-events:none; }
  .btn.enabled { cursor:pointer; opacity:1; box-shadow:0 12px 18px rgba(255,43,134,.25); }
  .note { text-align:center; color:var(--muted); margin-top:2px; }
</style>
</head>
<body>
  <header class="header">
    <div class="logo-wrap">
      <img id="siteLogo" class="logo" alt="Connectivity Source" src="/logo-256.png">
    </div>
  </header>

  <main class="card">
    <h1>Goals & Gaps Tracker</h1>
    <h2>Select Your Store</h2>

    <label for="area">Area</label>
    <select id="area"><option value="">Select Area</option></select>

    <label for="region">Region</label>
    <select id="region" disabled><option value="">Select Region</option></select>

    <label for="district">District</label>
    <select id="district" disabled><option value="">Select District</option></select>

    <label for="store">Store</label>
    <select id="store" disabled><option value="">Select Store</option></select>

    <button id="goBtn" class="btn" disabled>DORT â†’</button>
    <div class="note">Your selections are saved on this device.</div>
  </main>

<script>
(async function() {
  const logoImg = document.getElementById('siteLogo');

  // 1) Extract inline logo from app/dort.html and use it as header image (fallback stays /logo-256.png)
  try {
    const res = await fetch('/app/dort.html', {cache: 'no-store'});
    if (res.ok) {
      const text = await res.text();
      const m = text.match(/data:image\/[a-zA-Z0-9.+-]+;base64,[A-Za-z0-9+/=]+/);
      if (m && m[0]) logoImg.src = m[0];
    }
  } catch (e) {
    console.warn('Could not extract embedded logo from /app/dort.html:', e);
  }

  // DOM references
  const areaSel = document.getElementById('area');
  const regionSel = document.getElementById('region');
  const districtSel = document.getElementById('district');
  const storeSel = document.getElementById('store');
  const goBtn = document.getElementById('goBtn');

  function uniq(arr) { return [...new Set(arr.filter(Boolean))].sort(); }
  function pick(obj, keys) { for (const k of keys) if (k in obj) return obj[k]; return ''; }

  // 2) Load locations.json from /app and normalize the data to an array of {area,region,district,store}
  let raw = null;
  try {
    const res2 = await fetch('/app/locations.json', { cache: 'no-store' });
    if (!res2.ok) throw new Error('HTTP '+res2.status);
    raw = await res2.json();
  } catch (e) {
    alert('Could not load store list. Please make sure "/app/locations.json" exists with Area/Region/District/Store data.');
    console.error(e);
    return;
  }

  // Normalize:
  // - If raw is an array of records, use it (attempt to pick common keys).
  // - If raw is an object (nested map), convert it.
  let data = [];
  if (Array.isArray(raw)) {
    data = raw.map(r => ({
      area:  pick(r, ['area','Area','AREA']),
      region:pick(r, ['region','Region','REGION']),
      district:pick(r, ['district','District','DISTRICT']),
      store: pick(r, ['store','Store','STORE','store_name','Store Name'])
    })).filter(row => row.area && row.region && row.district && row.store);
  } else if (raw && typeof raw === 'object') {
    // Expecting structure: { AREA: { REGION: { DISTRICT: [ "Store A", "Store B" ] } } }
    // But some files use AREA -> REGION -> DISTRICT -> [ stores ] (two-level or three-level). We'll handle up to three levels.
    for (const areaKey of Object.keys(raw)) {
      const areaVal = raw[areaKey];
      if (!areaVal || typeof areaVal !== 'object') continue;
      for (const regionKey of Object.keys(areaVal)) {
        const regionVal = areaVal[regionKey];
        if (!regionVal) continue;
        // regionVal might be an array (direct list of stores) or an object of districts -> arrays
        if (Array.isArray(regionVal)) {
          // no district level present, use regionKey as district too
          for (const storeName of regionVal) {
            data.push({ area: areaKey, region: regionKey, district: regionKey, store: String(storeName) });
          }
        } else if (typeof regionVal === 'object') {
          for (const districtKey of Object.keys(regionVal)) {
            const stores = regionVal[districtKey];
            if (!Array.isArray(stores)) continue;
            for (const storeName of stores) {
              data.push({ area: areaKey, region: regionKey, district: districtKey, store: String(storeName) });
            }
          }
        }
      }
    }
  }

  if (!data.length) {
    alert('No valid store entries found in /app/locations.json after normalization.');
    console.error('normalized locations:', data, 'raw:', raw);
    return;
  }

  // Populate area select
  uniq(data.map(r => r.area)).forEach(a => {
    const o = document.createElement('option'); o.value=o.textContent=a; areaSel.appendChild(o);
  });

  areaSel.addEventListener('change', () => {
    regionSel.innerHTML = '<option value="">Select Region</option>';
    districtSel.innerHTML = '<option value="">Select District</option>';
    storeSel.innerHTML = '<option value="">Select Store</option>';
    regionSel.disabled = districtSel.disabled = storeSel.disabled = true;
    goBtn.disabled = true; goBtn.classList.remove('enabled');

    const regs = uniq(data.filter(r => r.area===areaSel.value).map(r => r.region));
    regs.forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; regionSel.appendChild(o); });
    regionSel.disabled = regs.length===0;
  });

  regionSel.addEventListener('change', () => {
    districtSel.innerHTML = '<option value="">Select District</option>';
    storeSel.innerHTML = '<option value="">Select Store</option>';
    districtSel.disabled = storeSel.disabled = true;
    goBtn.disabled = true; goBtn.classList.remove('enabled');

    const dists = uniq(data.filter(r => r.area===areaSel.value && r.region===regionSel.value).map(r => r.district));
    dists.forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; districtSel.appendChild(o); });
    districtSel.disabled = dists.length===0;
  });

  districtSel.addEventListener('change', () => {
    storeSel.innerHTML = '<option value="">Select Store</option>';
    storeSel.disabled = true; goBtn.disabled = true; goBtn.classList.remove('enabled');

    const stores = uniq(data.filter(r => r.area===areaSel.value && r.region===regionSel.value && r.district===districtSel.value).map(r => r.store));
    stores.forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; storeSel.appendChild(o); });
    storeSel.disabled = stores.length===0;
  });

  storeSel.addEventListener('change', () => {
    const ok = !!storeSel.value;
    goBtn.disabled = !ok;
    if (ok) goBtn.classList.add('enabled'); else goBtn.classList.remove('enabled');
  });

  goBtn.addEventListener('click', () => {
    if (!storeSel.value) return;
    const sel = { area: areaSel.value, region: regionSel.value, district: districtSel.value, store: storeSel.value };
    try { localStorage.setItem('ggt_selection', JSON.stringify(sel)); } catch(e) {}
    try { localStorage.setItem('ggt.area', sel.area); localStorage.setItem('ggt.region', sel.region); localStorage.setItem('ggt.district', sel.district); localStorage.setItem('ggt.store', sel.store); } catch(e) {}
    location.href = '/app/dort.html';
  });
})();
</script>
</body>
</html>
