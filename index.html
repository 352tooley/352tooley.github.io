<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enable Notifications</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#d6006e" />
  <!-- iOS A2HS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icon-192.png">

  <style>
    :root { --magenta:#d6006e; --ink:#111; --muted:#666; --bg:#fafafa; --card:#fff; --border:#e5e7eb; }
    html,body { height:100%; }
    body {
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
      display:flex; align-items:center; justify-content:center;
    }
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      padding:28px 26px; max-width:520px; width:92%; box-shadow:0 8px 20px rgba(0,0,0,.06);
    }
    h1 { margin:0 0 8px; font-size:26px; color:var(--magenta); text-align:center; }
    p  { margin:8px 0 18px; color:var(--muted); text-align:center; }
    .row { display:flex; flex-direction:column; gap:10px; align-items:center; }
    button {
      background:var(--magenta); color:#fff; border:none; border-radius:12px;
      font-weight:800; letter-spacing:.3px; font-size:18px; padding:14px 18px; cursor:pointer; width:100%;
    }
    button:disabled { background:#ddd; color:#888; cursor:not-allowed; }
    .status { font-size:14px; color:#333; text-align:center; word-break:break-all; }
    .ok { color:#0a7a0a; font-weight:700; }
    .warn { color:#b85d00; font-weight:700; }
  </style>

  <!-- OneSignal v16 SDK (Page) -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>
  <main class="card">
    <h1>Enable Daily Notifications</h1>
    <p>Tap below and allow notifications to get your daily reminder.</p>
    <div class="row">
      <button id="btnEnable">ðŸ”” Enable notifications</button>
      <div id="status" class="status">Checking subscription...</div>
      <div id="pid" class="status" style="display:none"></div>
    </div>
  </main>

  <script>
    // After subscribing, redirect back to your app:
    const APP_URL = "/app/?sub=1";

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      try {
        await OneSignal.init({ appId: "5ecaba08-de2f-44b8-a4f0-369508265505" });

        const $ = (id) => document.getElementById(id);
        const btn = $('btnEnable');
        const status = $('status');
        const pidBox = $('pid');

        async function refreshStatus() {
          const optedIn = await OneSignal.User.PushSubscription.optedIn;
          if (optedIn) {
            const playerId = await OneSignal.User.PushSubscription.id;
            status.innerHTML = '<span class="ok">Subscribed</span>';
            if (playerId) { pidBox.style.display='block'; pidBox.textContent='Player ID: '+playerId; }
            btn.disabled = true; btn.textContent = 'Notifications Enabled';
            // redirect into the app
            window.location.href = APP_URL;
          } else {
            status.innerHTML = '<span class="warn">Not subscribed</span>';
            pidBox.style.display='none'; pidBox.textContent='';
            btn.disabled = false; btn.textContent = 'ðŸ”” Enable notifications';
          }
        }

        btn.addEventListener('click', async () => {
          await OneSignal.Slidedown.promptPush();
          await refreshStatus();
        });

        await refreshStatus();
      } catch (e) {
        document.getElementById('status').textContent = 'Init error: ' + (e && e.message ? e.message : e);
      }
    });
  </script>

  <!-- Register service worker (root scope) -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js")
        .then(reg => console.log("SW registered:", reg.scope))
        .catch(err => console.error("SW registration failed:", err));
    }
  </script>
</body>
</html>


