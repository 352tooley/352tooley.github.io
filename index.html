<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Goals & Gaps Tracker</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" href="logo-64.png" sizes="64x64">
  <style>
    :root{--ink:#111;--muted:#6b7280;--magenta:#d6006e;--border:#e5e7eb;--card:#fff;}
    html,body{height:100%;margin:0;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;-webkit-text-size-adjust:100%}
    header{display:flex;align-items:center;justify-content:center;padding:10px 0 0}
    .brand{width:100%;max-width:520px;height:94px;display:block;margin:0 auto;border-radius:16px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);}
    .brand img{width:100%;height:100%;object-fit:contain;display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px;margin:16px auto;width:min(92vw, 640px)}
    h1{margin:6px 0 0;text-align:center;color:var(--magenta);font-size:28px}
    h2{margin:14px 0 18px;text-align:center;font-size:22px;color:#111}
    .row{display:flex;flex-direction:column;gap:12px}
    select{width:100%;padding:14px 12px;border-radius:12px;border:1px solid var(--border);background:#f9fafb;font-size:16px}
    select:disabled{opacity:.7}
    .btn{margin-top:14px;width:100%;display:block;text-align:center;padding:16px 18px;border-radius:14px;background:var(--magenta);color:#fff;font-weight:700;border:none;font-size:20px}
    .muted{text-align:center;color:var(--muted);font-size:13px;margin-top:10px}
    @media (max-width:380px){ .brand{height:80px} .btn{font-size:18px} h1{font-size:24px}}
  </style>
</head>
<body>
  <header>
    <div class="brand"><img src="logo-512.png" alt="Connectivity Source"></div>
  </header>

  <main class="card">
    <h1>Goals &amp; Gaps Tracker</h1>
    <h2>Select Your Store</h2>
    <div class="row">
      <select id="areaSelect"><option value="">Select Area</option></select>
      <select id="regionSelect" disabled><option value="">Select Region</option></select>
      <select id="districtSelect" disabled><option value="">Select District</option></select>
      <select id="storeSelect" disabled><option value="">Select Store</option></select>
      <button id="goBtn" class="btn">DORT →</button>
      <div class="muted">Your selections are saved on this device.</div>
    </div>
  </main>

<script>
const PATH = "./locations.json"; // root index uses local file
const els = {
  area: document.getElementById('areaSelect'),
  region: document.getElementById('regionSelect'),
  district: document.getElementById('districtSelect'),
  store: document.getElementById('storeSelect'),
  go: document.getElementById('goBtn')
};
let TREE = {};

function optionize(el, list, placeholder){
  el.innerHTML = '<option value="">' + placeholder + '</option>';
  list.forEach(v => el.insertAdjacentHTML('beforeend','<option value="'+v+'">'+v+'</option>'));
  el.disabled = list.length === 0;
}

function normalizeStores(val){
  // Accept arrays of strings OR arrays of objects with name/label properties
  if (!Array.isArray(val)) return [];
  return val.map(x => {
    if (typeof x === 'string') return x;
    if (x && typeof x === 'object') return x.name || x.label || x.store || '';
    return '';
  }).filter(Boolean);
}

function fillFromTree(){
  const areas = Object.keys(TREE || {});
  optionize(els.area, areas, 'Select Area');
  // restore saved
  const a = localStorage.getItem('sel_area');
  const r = localStorage.getItem('sel_region');
  const d = localStorage.getItem('sel_district');
  const s = localStorage.getItem('sel_store');
  if (a && TREE[a]) { els.area.value = a; onArea(); }
  if (r && TREE[a] && TREE[a][r]) { els.region.value = r; onRegion(); }
  if (d && TREE[a] && TREE[a][r] && TREE[a][r][d]) { els.district.value = d; onDistrict(); }
  if (s) {
    Array.from(els.store.options).some(o => (o.value===s && (els.store.value=s)));
  }
}

function onArea(){
  const a = els.area.value;
  localStorage.setItem('sel_area', a || '');
  localStorage.removeItem('sel_region'); localStorage.removeItem('sel_district'); localStorage.removeItem('sel_store');
  const regions = a ? Object.keys(TREE[a] || {}) : [];
  optionize(els.region, regions, 'Select Region');
  optionize(els.district, [], 'Select District');
  optionize(els.store, [], 'Select Store');
}
function onRegion(){
  const a = els.area.value, r = els.region.value;
  localStorage.setItem('sel_region', r || '');
  localStorage.removeItem('sel_district'); localStorage.removeItem('sel_store');
  const districts = (a && r) ? Object.keys(TREE[a]?.[r] || {}) : [];
  optionize(els.district, districts, 'Select District');
  optionize(els.store, [], 'Select Store');
}
function onDistrict(){
  const a = els.area.value, r = els.region.value, d = els.district.value;
  localStorage.setItem('sel_district', d || '');
  localStorage.removeItem('sel_store');
  const stores = (a && r && d) ? normalizeStores(TREE[a]?.[r]?.[d]) : [];
  optionize(els.store, stores, 'Select Store');
}
function onStore(){
  const s = els.store.value;
  localStorage.setItem('sel_store', s || '');
}

els.area.addEventListener('change', onArea);
els.region.addEventListener('change', onRegion);
els.district.addEventListener('change', onDistrict);
els.store.addEventListener('change', onStore);
els.go.addEventListener('click', () => {
  // keep existing flow – this just demonstrates navigation hook
  alert('DORT pressed with: ' + [els.area.value, els.region.value, els.district.value, els.store.value].join(' > '));
});

fetch(PATH, {cache:'no-store'}).then(r => r.json()).then(data => {
  TREE = data || {};
  fillFromTree();
}).catch(err => {
  console.warn('Failed to load locations.json', err);
});
</script>
</body>
</html>
