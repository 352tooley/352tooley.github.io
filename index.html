
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Goals & Gaps Tracker</title>
<link rel="stylesheet" href="/print.css">
<style>
  :root {
    --brand:#e20074;
    --card:#fafafa; /* off-white to blend with logo background */
    --ring:#d0d0d0;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;overflow-x:hidden;background:#fff;}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif;line-height:1.25;}

  /* Header logo band */
  .brand-band{
    background:var(--card);
    padding:6px 10px 0;
    border-bottom:1px solid #eee;
  }
  .brand-band .logo{
    display:block;
    margin:0 auto;
    width:100%;
    max-width:720px;
    height:clamp(72px, 20vw, 140px);
    object-fit:contain; /* shows full logo, trims visual whitespace */
  }

  /* Card */
  .wrap{display:flex;justify-content:center;padding:12px;}
  .card{
    width:min(720px, 100%);
    background:#fff;
    border-radius:18px;
    box-shadow:0 8px 28px rgba(0,0,0,.08);
    padding:18px;
    margin-top:-2px; /* pull right up under the logo band */
  }

  h1{
    margin:6px 0 8px;
    text-align:center;
    color:var(--brand);
    font-size:clamp(24px, 4.8vw, 34px);
    letter-spacing:.3px;
  }
  h2{
    margin:0 0 12px;
    text-align:center;
    font-size:clamp(18px, 4vw, 24px);
    color:#111;
  }
  label{
    display:block;
    font-weight:600;
    margin:10px 0 6px;
    color:#333;
  }
  select{
    -webkit-appearance:none;
    appearance:none;
    width:100%;
    padding:14px 16px;
    border:1px solid var(--ring);
    border-radius:12px;
    background:#f6f6f6;
    font-size:18px;
    outline:none;
  }
  .btn{
    display:block;
    width:100%;
    border:0;
    border-radius:14px;
    padding:16px 14px;
    font-weight:800;
    letter-spacing:.4px;
    text-align:center;
    background:var(--brand);
    color:#fff;
    margin-top:16px;
    font-size:22px;
  }
  .btn:disabled{
    background:#e5a8c9;
    color:#fff;
    opacity:.85;
  }
  .tip{text-align:center;color:#666;margin-top:10px;}

  /* Prevent sideways scroll on iOS */
  .safe{
    padding-bottom:env(safe-area-inset-bottom);
  }
</style>
</head>
<body class="safe">
<div class="brand-band">
  <img class="logo" src="/logo-512.png" alt="Connectivity Source">
</div>
<div class="wrap">
  <main class="card">
    <h1>Goals &amp; Gaps Tracker</h1>
    <h2>Select Your Store</h2>

    <label for="areaSelect">Area</label>
    <select id="areaSelect"><option value="">Select Area</option></select>

    <label for="regionSelect">Region</label>
    <select id="regionSelect" disabled><option value="">Select Region</option></select>

    <label for="districtSelect">District</label>
    <select id="districtSelect" disabled><option value="">Select District</option></select>

    <label for="storeSelect">Store</label>
    <select id="storeSelect" disabled><option value="">Select Store</option></select>

    <button id="dortBtn" class="btn" disabled>DORT â†’</button>
    <p class="tip">Your selections are saved on this device.</p>
  </main>
</div>
<script>
(async function() {
  const selArea = document.getElementById('areaSelect');
  const selRegion = document.getElementById('regionSelect');
  const selDistrict = document.getElementById('districtSelect');
  const selStore = document.getElementById('storeSelect');
  const dortBtn = document.getElementById('dortBtn');

  function getVal(o, names) {
    for (const n of names) {
      if (o[n] != null && String(o[n]).trim() !== '') return String(o[n]).trim();
    }
    return '';
  }

  async function tryFetch(url) {
    try {
      const r = await fetch(url + (url.includes('?') ? '' : '?_=' + Date.now()));
      if (r.ok) return await r.json();
    } catch(e) {}
    return null;
  }

  const sources = [
    './locations.json',
    '/locations.json',
    '/app/locations.json',
    '../locations.json'
  ];

  let data=null;
  for (const s of sources) {
    data = await tryFetch(s);
    if (Array.isArray(data) && data.length) break;
  }
  if (!Array.isArray(data)) {
    console.error('locations.json not found or invalid'); 
    return;
  }

  // Normalize to Area/Region/District/Store
  const rows = data.map(r => ({
    area: getVal(r, ['area','Area','AREA','S','s']),
    region: getVal(r, ['region','Region','REGION','P','p']),
    district: getVal(r, ['district','District','DISTRICT','M','m']),
    store: getVal(r, ['store','Store','STORE','store_name','D','d'])
  })).filter(r => r.area && r.region && r.district && r.store);

  // Build maps
  const byArea = new Map();
  for (const r of rows) {
    if (!byArea.has(r.area)) byArea.set(r.area, new Map());
    const reg = byArea.get(r.area);
    if (!reg.has(r.region)) reg.set(r.region, new Map());
    const dist = reg.get(r.region);
    if (!dist.has(r.district)) dist.set(r.district, new Set());
    dist.get(r.district).add(r.store);
  }

  function fillSelect(sel, items, placeholder) {
    sel.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value=''; opt0.textContent = placeholder; sel.appendChild(opt0);
    for (const v of items) {
      const o = document.createElement('option');
      o.value = o.textContent = v; sel.appendChild(o);
    }
    sel.disabled = items.length === 0;
  }

  function uniqueSorted(iter){
    return Array.from(new Set(Array.from(iter))).sort((a,b)=>a.localeCompare(b));
  }

  // Restore last picks if available; else pick firsts so the page looks filled.
  const saved = JSON.parse(localStorage.getItem('storePath') || '{}');

  const areaList = uniqueSorted(byArea.keys());
  fillSelect(selArea, areaList, 'Select Area');

  function setSelectValue(sel, val){
    if (!val) return false;
    for (const o of sel.options) { if (o.value === val) { sel.value = val; return true; } }
    return false;
  }

  // populate cascade based on current selections
  function populateRegions() {
    const area = selArea.value;
    const regMap = byArea.get(area) || new Map();
    fillSelect(selRegion, uniqueSorted(regMap.keys()), 'Select Region');
  }
  function populateDistricts() {
    const area = selArea.value;
    const regMap = byArea.get(area) || new Map();
    const distMap = regMap.get(selRegion.value) || new Map();
    fillSelect(selDistrict, uniqueSorted(distMap.keys()), 'Select District');
  }
  function populateStores() {
    const area = selArea.value;
    const regMap = byArea.get(area) || new Map();
    const distMap = regMap.get(selRegion.value) || new Map();
    const storeSet = distMap.get(selDistrict.value) || new Set();
    fillSelect(selStore, uniqueSorted(storeSet.values()), 'Select Store');
  }

  selArea.addEventListener('change', ()=>{ populateRegions(); populateDistricts(); populateStores(); update(); });
  selRegion.addEventListener('change', ()=>{ populateDistricts(); populateStores(); update(); });
  selDistrict.addEventListener('change', ()=>{ populateStores(); update(); });
  selStore.addEventListener('change', update);

  function prefill() {
    // 1) set area
    if (!setSelectValue(selArea, saved.area)) selArea.value = areaList[0] || '';
    populateRegions();
    // 2) region
    if (!setSelectValue(selRegion, saved.region)) selRegion.selectedIndex = Math.min(1, selRegion.options.length-1);
    populateDistricts();
    // 3) district
    if (!setSelectValue(selDistrict, saved.district)) selDistrict.selectedIndex = Math.min(1, selDistrict.options.length-1);
    populateStores();
    // 4) store
    if (!setSelectValue(selStore, saved.store)) selStore.selectedIndex = Math.min(1, selStore.options.length-1);
    update();
  }

  function update(){
    const enabled = !!selStore.value;
    dortBtn.disabled = !enabled;
    selRegion.disabled = !selArea.value;
    selDistrict.disabled = !selRegion.value;
    selStore.disabled = !selDistrict.value;
    if (enabled) {
      localStorage.setItem('storePath', JSON.stringify({
        area: selArea.value, region: selRegion.value, district: selDistrict.value, store: selStore.value
      }));
    }
  }

  prefill();

  dortBtn.addEventListener('click', () => {
    if (!selStore.value) return;
    // Navigate to summary.html in same folder; try fallbacks if moved
    const tryUrls = [
      'summary.html',
      './summary.html',
      '/summary.html',
      '/app/summary.html'
    ];
    for (const u of tryUrls) { 
      window.location.href = u + '?_=' + Date.now(); 
      break;
    }
  });
})();
</script>
</body></html>