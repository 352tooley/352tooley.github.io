<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Tracker</title>
    <style>
      :root{
        --magenta:#d6006e;
        --bg:#fafafa; --card:#ffffff; --ink:#222; --muted:#666; --border:#dcdcdc;
        --radius:12px;
        --fs-base:18px; --fs-label:18px; --fs-h2:26px; --fs-btn:18px;
        --control-h:56px;
      }
      html,body{height:100%; overflow-x:hidden;}
      body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); font-size:var(--fs-base);}

      .topbar{display:flex; align-items:center; justify-content:center; padding:10px 0; border-bottom:1px solid var(--border);}
      .brand{font-weight:900; color:var(--magenta); letter-spacing:.3px;}

      h2{margin:10px 0 12px; color:var(--magenta); text-align:center; font-size:var(--fs-h2);}
      .container{padding:12px 16px 22px; max-width:720px; margin:0 auto;}
      .metric{margin:14px 0;}
      .metric label{display:block; margin-bottom:8px; font-weight:700; font-size:var(--fs-label);}
      .pair{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px;}
      @media(max-width:420px){ .pair{grid-template-columns:1fr;} }
      input,select{width:100%; max-width:100%; min-width:0; height:var(--control-h); padding:10px 12px; font-size:18px; border:1px solid var(--border); border-radius:12px; background:#fff; color:#111; box-sizing:border-box;}
      .buttons{margin:18px 0 24px; display:flex; gap:12px;}
      button{flex:1; height:var(--control-h); padding:0 16px; font-size:var(--fs-btn); font-weight:800; letter-spacing:.2px; border:none; border-radius:12px; cursor:pointer;}
      .back{background:#e9e9e9; color:#333;}
      .next{background:var(--magenta); color:#fff;}
      button:disabled{background:#efefef; color:#9b9b9b; cursor:not-allowed;}

      .sec{background:var(--card); padding:16px; border-radius:var(--radius); border:1px solid var(--border); box-shadow:0 2px 6px rgba(0,0,0,.05); margin:12px 0;}
      .kv{display:flex; justify-content:space-between; gap:12px; margin:6px 0;}

      .status{padding:4px 10px; border-radius:999px; font-size:14px; font-weight:800; display:inline-block}
      .ok{background:rgba(0,200,0,.14); color:#0a0; border:1px solid rgba(0,200,0,.28)}
      .warn{background:rgba(255,200,0,.16); color:#a60; border:1px solid rgba(255,200,0,.32)}
      .bad{background:rgba(255,80,80,.16); color:#a00; border:1px solid rgba(255,80,80,.32)}

      .sum-head{margin:2px 0 10px; text-align:center;}
      .sum-date,.sum-store{font-size:20px; font-weight:800;}
      .sum-grid{display:grid; grid-template-columns:1fr; gap:12px;}
      .tile{display:flex; flex-direction:column; justify-content:flex-start;}
      .tile.tall{min-height:220px;}
      .tile.short{min-height:190px;}
      @media(min-width:760px){
        .container{max-width:1100px;}
        .sum-grid{grid-template-columns:1fr 1fr; gap:12px;}
      }

      @media print{
        @page{ size: Letter; margin: 0.5in; }
        body{ background:#fff; color:#000; }
        .buttons,.reminder{ display:none!important; }
        .sec{ box-shadow:none; border:1px solid #ccc; }
        .sum-grid{ grid-template-columns:1fr 1fr; gap:10px; }
        .sum-head .sum-date, .sum-head .sum-store{ font-size:18px; }
      }

      .reminder {text-align:center; margin-top:8px;}
      .reminder button {background:#111; color:#fff; height:auto; padding:10px 14px; border-radius:8px; font-size:16px; font-weight:800;}
    </style>
  </head>
  <body>
    <div class="topbar"><div class="brand">T-Mobile Daily Tracker</div></div>
    <div id="app" class="container"></div>

    <script>
      /* ---------------- Config ---------------- */
      const SHIM_URL = 'https://352tooley.github.io/'; // root notifications shim

      const byId = id => document.getElementById(id);
      const setScreen = html => { byId('app').innerHTML = html; };
      const num = v => parseFloat(v||0) || 0;
      const int = v => parseInt(v||0) || 0;
      const todayStr = () => new Date().toLocaleDateString();
      const money = v => '$' + (num(v).toFixed(2));
      const pctRound = v => Math.round(num(v));

      const bandPct   = p => (num(p)>=90?'ok':(num(p)>=60?'warn':'bad'));
      const bandGap   = g => (num(g)<=0?'ok':'bad');
      const bandScore = s => (num(s)>=9.5?'ok':(num(s)>=9.0?'warn':'bad'));
      const bandNeeded= n => (num(n)===0?'ok':'bad');
      const bandMrc   = (m,t) => (num(m)>=num(t)?'ok':((num(t)-num(m))<=1?'warn':'bad'));
      const fmtGap = v => v>0?`+${v}`:`${v}`;

      // Handle redirect flag from shim (?sub=1) & persist
      (function handleSub(){
        const params = new URLSearchParams(window.location.search);
        if (params.get('sub')==='1'){
          localStorage.setItem('remindersEnabled','1');
          window.history.replaceState({}, document.title, window.location.pathname);
          setTimeout(()=>alert("‚úÖ Notifications enabled! You‚Äôll now get daily reminders."),50);
        }
      })();

      const metric = (label,id1,id2,p1='Attainment',p2='Goal') => `
        <div class="metric">
          <label>${label}</label>
          <div class="pair">
            <input id="${id1}" type="number" placeholder="${p1}" value="${localStorage.getItem(id1)||''}" oninput="localStorage.setItem('${id1}',this.value)">
            <input id="${id2}" type="number" placeholder="${p2}" value="${localStorage.getItem(id2)||''}" oninput="localStorage.setItem('${id2}',this.value)">
          </div>
        </div>`;

      /* ---------------- Screens ---------------- */
      function showLocation(){
        const already = localStorage.getItem('remindersEnabled')==='1';
        const reminderBtn = already?'':`
          <div class="reminder">
            <button id="enablePushBtn">üîî Enable daily reminders</button>
          </div>`;
        const html = `
          <h2>Select Location</h2>
          <div class="sec">
            <label>Store</label>
            <select id="storeSel">
              <option value="">‚Äî Choose Store ‚Äî</option>
              <option>Cleburne</option><option>Rufe Snow</option><option>Chisholm</option>
              <option>28th St</option><option>Clifford</option><option>Golden Triangle</option>
              <option>Granbury</option><option>Stephenville</option><option>Weatherford</option>
            </select>
          </div>
          <div class="buttons">
            <button class="next" id="toDORT" disabled>DORT ‚Üí</button>
          </div>
          ${reminderBtn}
        `;
        setScreen(html);

        // Reset daily but keep reminder flag
        const todayKey=new Date().toISOString().slice(0,10);
        if(localStorage.getItem('lastDay')!==todayKey){
          const keep=localStorage.getItem('remindersEnabled'); localStorage.clear();
          if(keep)localStorage.setItem('remindersEnabled',keep);
          localStorage.setItem('lastDay',todayKey);
        }

        const sel=byId('storeSel');
        const saved=localStorage.getItem('storeSel')||'';
        if(saved){sel.value=saved;}
        sel.onchange=e=>{
          localStorage.setItem('storeSel',e.target.value||'');
          byId('toDORT').disabled=!e.target.value;
        };
        byId('toDORT').disabled=!sel.value;
        byId('toDORT').onclick=showDORT;

        const btn=byId('enablePushBtn');
        if(btn){
          btn.addEventListener('click',()=>{
            window.open(SHIM_URL,'_blank');
            localStorage.setItem('remindersEnabled','1'); // hide next time
            btn.textContent='Notifications Enabled';
            btn.disabled=true;
          });
        }
      }

      function showDORT(){
        setScreen(`
          <h2>DORT ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${metric('Voice','d_v_att','d_v_goal')}
          ${metric('BTS','d_b_att','d_b_goal')}
          ${metric('TFB','d_t_att','d_t_goal')}
          ${metric('Accessories','d_a_att','d_a_goal')}
          <div class="buttons">
            <button class="back" onclick="showLocation()">‚Üê Store</button>
            <button class="next" onclick="showSORT()">SORT ‚Üí</button>
          </div>`);
      }

      function showSORT(){
        setScreen(`
          <h2>SORT ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${metric('Voice','s_v_att','s_v_goal')}
          ${metric('BTS','s_b_att','s_b_goal')}
          ${metric('TFB','s_t_att','s_t_goal')}
          ${metric('Accessories','s_a_att','s_a_goal')}
          <div class="buttons">
            <button class="back" onclick="showDORT()">‚Üê DORT</button>
            <button class="next" onclick="showRevenue()">Revenue ‚Üí</button>
          </div>`);
      }

      function showRevenue(){
        setScreen(`
          <h2>Revenue ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${metric('P360','p_opp','p_pct','Opportunities','Attach %')}
          ${metric('VAF','v_opp','v_total','Opportunities','Total Revenue')}
          <div class="buttons">
            <button class="back" onclick="showSORT()">‚Üê SORT</button>
            <button class="next" onclick="showCSAT()">CSAT ‚Üí</button>
          </div>`);
      }

      function showCSAT(){
        setScreen(`
          <h2>CSAT ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${metric('CSAT','c_score','c_surveys','Current Score (0‚Äì10)','Surveys Taken')}
          <div class="buttons">
            <button class="back" onclick="showRevenue()">‚Üê Revenue</button>
            <button class="next" onclick="showTL()">T-Life ‚Üí</button>
          </div>`);
      }

      function showTL(){
        setScreen(`
          <h2>T-Life ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${metric('T-Life','t2_att','t2_opp','Attainment %','Opportunities')}
          <div class="buttons">
            <button class="back" onclick="showCSAT()">‚Üê CSAT</button>
            <button class="next" onclick="showDaily()">Daily Goals ‚Üí</button>
          </div>`);
      }

      function showDaily(){
        setScreen(`
          <h2>Daily Goals ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${metric('Voice','g_v_att','g_v_goal')}
          ${metric('BTS','g_b_att','g_b_goal')}
          ${metric('HSI','g_h_att','g_h_goal')}
          ${metric('HSI+BTS','g_hb_att','g_hb_goal')}
          ${metric('Accessories','g_a_att','g_a_goal')}
          <div class="buttons">
            <button class="back" onclick="showTL()">‚Üê T-Life</button>
            <button class="next" onclick="showSummary()">Summary ‚Üí</button>
          </div>`);
      }

      function showSummary(){
        const dateStr = todayStr();

        // (Simple example summary; replace with your detailed math version if desired)
        const sec = (label,a,g)=>`<div class="sec tile">${label}: ${localStorage.getItem(a)||0}/${localStorage.getItem(g)||0}</div>`;

        setScreen(`
          <h2>Summary</h2>
          <div class="sum-head">
            <div class="sum-store">${localStorage.getItem('storeSel')||''}</div>
            <div class="sum-date">${dateStr}</div>
          </div>
          <div class="sum-grid">
            ${sec('Voice','g_v_att','g_v_goal')}
            ${sec('BTS','g_b_att','g_b_goal')}
            ${sec('HSI','g_h_att','g_h_goal')}
            ${sec('HSI+BTS','g_hb_att','g_hb_goal')}
            ${sec('Accessories','g_a_att','g_a_goal')}
          </div>
          <div class="buttons">
            <button class="back" onclick="showDaily()">‚Üê Daily Goals</button>
            <button class="next" onclick="window.print()">üñ® Print</button>
          </div>`);
      }

      // Launch
      showLocation();
    </script>

    <!-- Register service worker from /app/ too (scope is root) -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js")
          .then(reg => console.log("SW registered from /app:", reg.scope))
          .catch(err => console.error("SW registration failed from /app:", err));
      }
    </script>
  </body>
</html>
