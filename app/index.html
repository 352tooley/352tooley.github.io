<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Tracker</title>
    <style>
      :root{
        --magenta:#d6006e;
        --bg:#fafafa; --card:#ffffff; --ink:#222; --muted:#666; --border:#dcdcdc;
        --radius:12px;
        --fs-base:18px; --fs-label:18px; --fs-h2:26px; --fs-btn:18px;
        --control-h:56px;
      }
      html,body{height:100%; overflow-x:hidden;}
      body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); font-size:var(--fs-base);}

      .topbar{display:flex; align-items:center; justify-content:center; padding:10px 0; border-bottom:1px solid var(--border);}
      .brand{font-weight:900; color:var(--magenta); letter-spacing:.3px;}

      h2{margin:10px 0 12px; color:var(--magenta); text-align:center; font-size:var(--fs-h2);}
      .container{padding:12px 16px 22px; max-width:720px; margin:0 auto;}
      .metric{margin:14px 0;}
      .metric label{display:block; margin-bottom:8px; font-weight:700; font-size:var(--fs-label);}
      .pair{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px;}
      @media(max-width:420px){ .pair{grid-template-columns:1fr;} }
      input,select{width:100%; max-width:100%; min-width:0; height:var(--control-h); padding:10px 12px; font-size:18px; border:1px solid var(--border); border-radius:12px; background:#fff; color:#111; box-sizing:border-box;}
      .buttons{margin:18px 0 24px; display:flex; gap:12px;}
      button{flex:1; height:var(--control-h); padding:0 16px; font-size:var(--fs-btn); font-weight:800; letter-spacing:.2px; border:none; border-radius:12px; cursor:pointer;}
      .back{background:#e9e9e9; color:#333;}
      .next{background:var(--magenta); color:#fff;}
      button:disabled{background:#efefef; color:#9b9b9b; cursor:not-allowed;}

      .sec{background:var(--card); padding:16px; border-radius:var(--radius); border:1px solid var(--border); box-shadow:0 2px 6px rgba(0,0,0,.05); margin:12px 0;}
      .kv{display:flex; justify-content:space-between; gap:12px; margin:6px 0;}

      .status{padding:4px 10px; border-radius:999px; font-size:14px; font-weight:800; display:inline-block}
      .ok{background:rgba(0,200,0,.14); color:#0a0; border:1px solid rgba(0,200,0,.28)}
      .warn{background:rgba(255,200,0,.16); color:#a60; border:1px solid rgba(255,200,0,.32)}
      .bad{background:rgba(255,80,80,.16); color:#a00; border:1px solid rgba(255,80,80,.32)}

      /* Summary layout */
      .sum-head{margin:2px 0 10px; text-align:center;}
      .sum-date,.sum-store{font-size:20px; font-weight:800;}
      .sum-grid{display:grid; grid-template-columns:1fr; gap:12px;}
      .tile{display:flex; flex-direction:column; justify-content:flex-start;}
      .tile.tall{min-height:220px;}
      .tile.short{min-height:190px;}
      @media(min-width:760px){
        .container{max-width:1100px;}
        .sum-grid{grid-template-columns:1fr 1fr; gap:12px;}
      }

      @media print{
        @page{ size: Letter; margin: 0.5in; }
        body{ background:#fff; color:#000; }
        .buttons,.reminder{ display:none!important; }
        .sec{ box-shadow:none; border:1px solid #ccc; }
        .sum-grid{ grid-template-columns:1fr 1fr; gap:10px; }
        .sum-head .sum-date, .sum-head .sum-store{ font-size:18px; }
      }

      .reminder {text-align:center; margin-top:8px;}
      .reminder button {background:#111; color:#fff; height:auto; padding:10px 14px; border-radius:8px; font-size:16px; font-weight:800;}
    </style>
  </head>
  <body>
    <div class="topbar"><div class="brand">T-Mobile Daily Tracker</div></div>
    <div id="app" class="container"></div>

    <script>
      /* ---------------- Config ---------------- */
      const SHIM_URL = 'https://352tooley.github.io/'; // root notifications shim
      const state = { store:null, cfg:{ p360:60, tlife:70, vaf:19 } };

      const byId = id => document.getElementById(id);
      const setScreen = html => { byId('app').innerHTML = html; };
      const num = v => parseFloat(v||0) || 0;
      const int = v => parseInt(v||0) || 0;
      const todayStr = () => new Date().toLocaleDateString();
      const money = v => '$' + (num(v).toFixed(2));
      const pctRound = v => Math.round(num(v));

      const bandPct   = p => (num(p)>=90?'ok':(num(p)>=60?'warn':'bad'));
      const bandGap   = g => (num(g)<=0?'ok':'bad');
      const bandScore = s => (num(s)>=9.5?'ok':(num(s)>=9.0?'warn':'bad'));
      const bandNeeded= n => (num(n)===0?'ok':'bad');
      const bandMrc   = (m,t) => (num(m)>=num(t)?'ok':((num(t)-num(m))<=1?'warn':'bad'));
      const fmtGap = v => v>0?`+${v}`:`${v}`;

      // Handle redirect from shim (?sub=1)
      (function handleSub(){
        const params = new URLSearchParams(window.location.search);
        if (params.get('sub')==='1'){
          localStorage.setItem('remindersEnabled','1');
          window.history.replaceState({}, document.title, window.location.pathname);
          setTimeout(()=>alert("‚úÖ Notifications enabled! You‚Äôll now get daily reminders."),50);
        }
      })();

      /* --------- Inputs --------- */
      const metric = (label,id1,id2,p1='Attainment',p2='Goal') => `
        <div class="metric">
          <label>${label}</label>
          <div class="pair">
            <input id="${id1}" type="number" placeholder="${p1}" value="${localStorage.getItem(id1)||''}" oninput="localStorage.setItem('${id1}',this.value)">
            <input id="${id2}" type="number" placeholder="${p2}" value="${localStorage.getItem(id2)||''}" oninput="localStorage.setItem('${id2}',this.value)">
          </div>
        </div>`;

      const single = (label,id,ph) => `
        <div class="metric">
          <label>${label}</label>
          <input id="${id}" type="number" placeholder="${ph}" value="${localStorage.getItem(id)||''}" oninput="localStorage.setItem('${id}',this.value)">
        </div>`;

      /* ---------------- Screens ---------------- */
      function showLocation(){
        const already = localStorage.getItem('remindersEnabled')==='1';
        const reminderBtn = already?'':`
          <div class="reminder">
            <button id="enablePushBtn">üîî Enable daily reminders</button>
          </div>`;
        const html = `
          <h2>Select Location</h2>
          <div class="sec">
            <label>Store</label>
            <select id="storeSel">
              <option value="">‚Äî Choose Store ‚Äî</option>
              <option>Cleburne</option><option>Rufe Snow</option><option>Chisholm</option>
              <option>28th St</option><option>Clifford</option><option>Golden Triangle</option>
              <option>Granbury</option><option>Stephenville</option><option>Weatherford</option>
            </select>
          </div>
          <div class="buttons">
            <button class="next" id="toDORT" disabled>DORT ‚Üí</button>
          </div>
          ${reminderBtn}
        `;
        setScreen(html);

        // Reset daily but keep reminders flag
        const todayKey=new Date().toISOString().slice(0,10);
        if(localStorage.getItem('lastDay')!==todayKey){
          const keep=localStorage.getItem('remindersEnabled'); localStorage.clear();
          if(keep)localStorage.setItem('remindersEnabled',keep);
          localStorage.setItem('lastDay',todayKey);
        }

        const sel=byId('storeSel');
        const saved=localStorage.getItem('storeSel')||'';
        if(saved){sel.value=saved;}
        sel.onchange=e=>{
          localStorage.setItem('storeSel',e.target.value||'');
          byId('toDORT').disabled=!e.target.value;
        };
        byId('toDORT').disabled=!sel.value;
        byId('toDORT').onclick=showDORT;

        const btn=byId('enablePushBtn');
        if(btn){
          btn.addEventListener('click',()=>{
            window.open(SHIM_URL,'_blank');
            localStorage.setItem('remindersEnabled','1');
            btn.textContent='Notifications Enabled';
            btn.disabled=true;
          });
        }
      }

      function showDORT(){
        setScreen(`
          <h2>DORT ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${metric('Voice','d_v_att','d_v_goal')}
          ${metric('BTS','d_b_att','d_b_goal')}
          ${metric('TFB','d_t_att','d_t_goal')}
          ${metric('Accessories','d_a_att','d_a_goal')}
          <div class="buttons">
            <button class="back" onclick="showLocation()">‚Üê Store</button>
            <button class="next" onclick="showSORT()">SORT ‚Üí</button>
          </div>`);
      }

      function showSORT(){
        setScreen(`
          <h2>SORT ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${metric('Voice','s_v_att','s_v_goal')}
          ${metric('BTS','s_b_att','s_b_goal')}
          ${metric('TFB','s_t_att','s_t_goal')}
          ${metric('Accessories','s_a_att','s_a_goal')}
          <div class="buttons">
            <button class="back" onclick="showDORT()">‚Üê DORT</button>
            <button class="next" onclick="showRevenue()">Revenue ‚Üí</button>
          </div>`);
      }

      function showRevenue(){
        setScreen(`
          <h2>Revenue ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${metric('P360','p_opp','p_pct','Opportunities','Attach %')}
          ${metric('VAF','v_opp','v_total','Opportunities','Total Revenue')}
          <div class="buttons">
            <button class="back" onclick="showSORT()">‚Üê SORT</button>
            <button class="next" onclick="showCSAT()">CSAT ‚Üí</button>
          </div>`);
      }

      function showCSAT(){
        setScreen(`
          <h2>CSAT ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${single('Current Score (0‚Äì10)','c_score','Score')}
          ${single('Surveys Taken','c_surveys','# Surveys')}
          <div class="buttons">
            <button class="back" onclick="showRevenue()">‚Üê Revenue</button>
            <button class="next" onclick="showTL()">T-Life ‚Üí</button>
          </div>`);
      }

      function showTL(){
        setScreen(`
          <h2>T-Life ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${single('Attainment %','t2_att','%')}
          ${single('Opportunities','t2_opp','#')}
          <div class="buttons">
            <button class="back" onclick="showCSAT()">‚Üê CSAT</button>
            <button class="next" onclick="showDaily()">Daily Goals ‚Üí</button>
          </div>`);
      }

      function showDaily(){
        setScreen(`
          <h2>Daily Goals ‚Äî ${localStorage.getItem('storeSel')||''}</h2>
          ${single('Voice','g_voice','Goal')}
          ${single('BTS','g_bts','Goal')}
          ${single('Accessories','g_acc','Goal')}
          ${single('TFB','g_tfb','Goal')}
          <div class="buttons">
            <button class="back" onclick="showTL()">‚Üê T-Life</button>
            <button class="next" onclick="showSummary()">Summary ‚Üí</button>
          </div>`);
      }

      function showSummary(){
        const dateStr = todayStr();

        // Combine DORT + SORT for each metric
        const comb = (aD,gD,aS,gS) => {
          const att = int(localStorage.getItem(aD)) + int(localStorage.getItem(aS));
          const goal= int(localStorage.getItem(gD)) + int(localStorage.getItem(gS));
          const pct = goal>0 ? Math.round((att/goal)*100) : 0;
          const gap = goal - att;
          return {att,goal,pct,gap};
        };
        const voice = comb('d_v_att','d_v_goal','s_v_att','s_v_goal');
        const bts   = comb('d_b_att','d_b_goal','s_b_att','s_b_goal');
        const tfb   = comb('d_t_att','d_t_goal','s_t_att','s_t_goal');
        const acc   = comb('d_a_att','d_a_goal','s_a_att','s_a_goal');

        // P360 ‚Äî % to goal (input) and needed tx to reach 60% going forward
        const pOpp=int(localStorage.getItem('p_opp'));
        const pPctIn=Math.max(0, Math.min(100, num(localStorage.getItem('p_pct'))));
        const pAtt=Math.round(pOpp*(pPctIn/100));
        const tP=(state.cfg.p360)/100;
        const pNeed=Math.max(0, Math.ceil((tP*pOpp - pAtt) / (1 - tP)));
        const pPctRounded = pctRound(pPctIn);

        // CSAT ‚Äî perfect 10s needed to reach 9.5 going forward
        const cAvg=num(localStorage.getItem('c_score'));
        const cN =int(localStorage.getItem('c_surveys'));
        const cNeed=cAvg>=9.5?0:Math.max(0, Math.ceil(2 * cN * (9.5 - cAvg)));

        // T-Life ‚Äî opportunities needed to hit 70% going forward
        const tlPct=Math.max(0, Math.min(100, num(localStorage.getItem('t2_att'))));
        const tlOpp=int(localStorage.getItem('t2_opp'));
        const tlSuc=Math.round(tlOpp*(tlPct/100));
        const tT=(state.cfg.tlife)/100;
        const tlNeed=Math.max(0, Math.ceil((tT*tlOpp - tlSuc) / (1 - tT)));

        // VAF ‚Äî gap to average $19/op and current MRC
        const vOpp=int(localStorage.getItem('v_opp'));
        const vTot=num(localStorage.getItem('v_total'));
        const vTarget=state.cfg.vaf;
        const needTotal=vTarget*vOpp;
        const vGap=Math.max(0, needTotal - vTot);
        const mrc=vOpp>0 ? (vTot/vOpp) : 0;

        // Daily Goals (single-field goals)
        const gVoice = localStorage.getItem('g_voice') || '‚Äî';
        const gBts   = localStorage.getItem('g_bts')   || '‚Äî';
        const gAcc   = localStorage.getItem('g_acc')   || '‚Äî';
        const gTfb   = localStorage.getItem('g_tfb')   || '‚Äî';

        const head = `
          <div class="sum-head">
            <div class="sum-date">üìÖ ${dateStr}</div>
            <div class="sum-store">üìç ${localStorage.getItem('storeSel') || '‚Äî'}</div>
          </div>`;

        const cardDortSort = `<div class="sec tile tall">
          <div style="font-weight:800; margin-bottom:8px;">DORT + SORT</div>
          <div class="kv"><span>Voice</span>
            <span><span class="status ${bandGap(voice.gap)}">Gap: ${fmtGap(voice.gap)}</span> <span class="status ${bandPct(voice.pct)}">${voice.pct}%</span></span>
          </div>
          <div class="kv"><span>BTS</span>
            <span><span class="status ${bandGap(bts.gap)}">Gap: ${fmtGap(bts.gap)}</span> <span class="status ${bandPct(bts.pct)}">${bts.pct}%</span></span>
          </div>
          <div class="kv"><span>TFB</span>
            <span><span class="status ${bandGap(tfb.gap)}">Gap: ${fmtGap(tfb.gap)}</span> <span class="status ${bandPct(tfb.pct)}">${tfb.pct}%</span></span>
          </div>
          <div class="kv"><span>Accessories</span>
            <span><span class="status ${bandGap(acc.gap)}">Gap: ${fmtGap(acc.gap)}</span> <span class="status ${bandPct(acc.pct)}">${acc.pct}%</span></span>
          </div>
        </div>`;

        const cardGoals = `<div class="sec tile tall">
          <div style="font-weight:800; margin-bottom:8px;">üéØ Daily Goals</div>
          <div class="kv"><span>Voice</span><span><b>${gVoice}</b></span></div>
          <div class="kv"><span>BTS</span><span><b>${gBts}</b></span></div>
          <div class="kv"><span>TFB</span><span><b>${gTfb}</b></span></div>
          <div class="kv"><span>Accessories</span><span><b>${gAcc}</b></span></div>
        </div>`;

        const cardP360 = `<div class="sec tile short">
          <div style="font-weight:800; margin-bottom:8px;">üí° P360</div>
          <div class="kv"><span>% to Goal</span><span class="status ${bandPct(pPctRounded)}">${pPctRounded}%</span></div>
          <div class="kv"><span>Target</span><span>${state.cfg.p360}%</span></div>
          <div class="kv"><span>Needed</span><span class="status ${bandNeeded(pNeed)}">${pNeed} tx</span></div>
        </div>`;

        const cardCSAT = `<div class="sec tile short">
          <div style="font-weight:800; margin-bottom:8px;">‚≠ê CSAT</div>
          <div class="kv"><span>Score</span><span class="status ${bandScore(cAvg)}">${isNaN(cAvg)?'‚Äî':cAvg}</span></div>
          <div class="kv"><span>Target</span><span>9.5</span></div>
          <div class="kv"><span>Needed</span><span class="status ${bandNeeded(cNeed)}">${cNeed} perfect 10s</span></div>
        </div>`;

        const cardTLife = `<div class="sec tile short">
          <div style="font-weight:800; margin-bottom:8px;">üì± T-Life</div>
          <div class="kv"><span>Attainment</span><span class="status ${bandPct(tlPct)}">${pctRound(tlPct)}%</span></div>
          <div class="kv"><span>Target</span><span>${state.cfg.tlife}%</span></div>
          <div class="kv"><span>Needed</span><span class="status ${bandNeeded(tlNeed)}">${tlNeed} opportunities</span></div>
        </div>`;

        const cardVAF = `<div class="sec tile short">
          <div style="font-weight:800; margin-bottom:8px;">üíµ VAF</div>
          <div class="kv"><span>MRC</span><span class="status ${bandMrc(mrc,vTarget)}">${money(mrc)}</span></div>
          <div class="kv"><span>Target</span><span>${money(vTarget)}/op</span></div>
          <div class="kv"><span>Gap</span><span class="status ${bandGap(vGap)}">${money(vGap)}</span></div>
        </div>`;

        const grid = `
          ${head}
          <div class="sum-grid">
            ${cardDortSort}
            ${cardGoals}
            ${cardP360}
            ${cardCSAT}
            ${cardTLife}
            ${cardVAF}
          </div>
          <div class="buttons">
            <button class="back" onclick="showDaily()">‚Üê Daily Goals</button>
            <button class="next" onclick="window.print()">üñ® Print</button>
          </div>`;

        setScreen(grid);
      }

      // Launch
      showLocation();
    </script>

    <!-- Register service worker (root scope) -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js")
          .then(reg => console.log("SW registered from /app:", reg.scope))
          .catch(err => console.error("SW registration failed from /app:", err));
      }
    </script>
  </body>
</html>
