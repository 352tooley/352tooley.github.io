<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Store Summary</title>

  <!-- PWA manifest + meta (baked in) -->
  <link rel="manifest" href="/app/manifest.json">
  <meta name="theme-color" content="#e6007e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/app/icons/apple-touch-icon.png">

  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#fff;margin:0;color:#111}
    header{background:#f7f8fa;padding:12px;border-bottom:1px solid #e6e7ea}
    main{max-width:980px;margin:18px auto;padding:18px}
    .card{background:#fff;border:1px solid #e6e7ea;border-radius:8px;padding:14px;margin-bottom:12px}
    label{display:block;font-weight:700;margin-bottom:6px}
    input[type="text"]{padding:8px;width:220px;border:1px solid #e6e7ea;border-radius:6px}
    .muted{color:#6b7280;font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef0f3;text-align:left}
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;color:#e6007e">Store Summary</h1>
  </header>

  <main>
    <section class="card">
      <label>Test a store</label>
      <div style="display:flex;gap:10px;align-items:center">
        <input id="storeInput" type="text" placeholder="Enter store code (e.g. 2ESP)" />
        <input id="dateInput" type="date" />
        <button id="loadBtn" style="background:#e6007e;color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer">Load</button>
      </div>
      <div class="muted" style="margin-top:8px">This example uses monthly goals from your site (public JSON under /data/goals/<YYYY-MM>/daily-YYYY-MM.json and meta-YYYY-MM.json) or falls back to localStorage keys.</div>
    </section>

    <section class="card">
      <h3>Applied goals</h3>
      <table>
        <tbody>
          <tr><th>Store</th><td id="outStore">—</td></tr>
          <tr><th>Date</th><td id="outDate">—</td></tr>
          <tr><th>Voice</th><td id="outVoice">—</td></tr>
          <tr><th>BTS</th><td id="outBts">—</td></tr>
          <tr><th>TFB</th><td id="outTfb">—</td></tr>
          <tr><th>Accessories</th><td id="outAccessories">—</td></tr>
          <tr><th>VAF target</th><td id="outVaf">—</td></tr>
          <tr><th>T-Life target</th><td id="outTlife">—</td></tr>
          <tr><th>P360 target</th><td id="outP360">—</td></tr>
        </tbody>
      </table>
    </section>
  </main>

<script>
/*
  Summary example integration (baked in PWA):
  - Attempts to fetch published JSON at /data/goals/<YYYY-MM>/daily-<YYYY-MM>.json and meta-<YYYY-MM>.json
  - If fetch fails, falls back to localStorage keys monthly_goals:YYYY-MM and monthly_meta:YYYY-MM
  - Matches the store using canonical store_code (the code portion before ':'), e.g., "2ESP"
  - Applies daily metrics (voice, bts, tfb, accessories) and meta (global or per-store overrides)
*/

function canonicalStoreCode(full) {
  if (!full && full !== 0) return '';
  const s = String(full).trim();
  const idx = s.indexOf(':');
  if (idx > -1) return s.slice(0, idx).trim();
  const parts = s.split(/\s+/);
  return parts[0] || s;
}

async function fetchJson(url) {
  try {
    const r = await fetch(url, {cache: 'no-cache'});
    if (!r.ok) throw new Error('not-found');
    return await r.json();
  } catch (e) {
    return null;
  }
}

async function loadMonthlyDataForMonth(monthStr) {
  // Try site-hosted files first
  const dailyUrl = `/data/goals/${monthStr}/daily-${monthStr}.json`;
  const metaUrl = `/data/goals/${monthStr}/meta-${monthStr}.json`;

  const [dailyRemote, metaRemote] = await Promise.all([fetchJson(dailyUrl), fetchJson(metaUrl)]);
  if (dailyRemote || metaRemote) {
    return { daily: dailyRemote, meta: metaRemote };
  }

  // Fallback to localStorage
  const dailyKey = 'monthly_goals:' + monthStr;
  const metaKey = 'monthly_meta:' + monthStr;
  const dailyStr = localStorage.getItem(dailyKey);
  const metaStr = localStorage.getItem(metaKey);
  const daily = dailyStr ? JSON.parse(dailyStr) : null;
  const meta = metaStr ? JSON.parse(metaStr) : null;
  return { daily, meta };
}

function applyToUI(storeCode, dateObj, monthly) {
  document.getElementById('outStore').textContent = storeCode;
  document.getElementById('outDate').textContent = dateObj.toISOString().slice(0,10);

  // defaults
  let voice = '—', bts = '—', tfb = '—', accessories = '—';
  let vaf = '—', tlife = '—', p360 = '—';

  if (monthly && monthly.daily && monthly.daily.stores) {
    const store = monthly.daily.stores[storeCode];
    const day = String(dateObj.getDate());
    if (store && store.daily && store.daily[day]) {
      const metrics = store.daily[day];
      if (metrics.voice !== undefined) voice = metrics.voice;
      if (metrics.bts !== undefined) bts = metrics.bts;
      if (metrics.tfb !== undefined) tfb = metrics.tfb;
      if (metrics.accessories !== undefined) accessories = metrics.accessories;
    } else {
      // no daily row for this store/day
    }
  }

  // apply meta global/per-store overrides
  if (monthly && monthly.meta && monthly.meta.global_goals) {
    vaf = monthly.meta.global_goals.vaf !== null ? monthly.meta.global_goals.vaf : vaf;
    tlife = monthly.meta.global_goals.tlife !== null ? monthly.meta.global_goals.tlife : tlife;
    p360 = monthly.meta.global_goals.p360 !== null ? monthly.meta.global_goals.p360 : p360;
  }
  // apply per-store override if present
  if (monthly && monthly.meta && monthly.meta.per_store_overrides && monthly.meta.per_store_overrides[storeCode]) {
    const o = monthly.meta.per_store_overrides[storeCode];
    if (o.vaf !== undefined && o.vaf !== null) vaf = o.vaf;
    if (o.tlife !== undefined && o.tlife !== null) tlife = o.tlife;
    if (o.p360 !== undefined && o.p360 !== null) p360 = o.p360;
  }

  document.getElementById('outVoice').textContent = voice;
  document.getElementById('outBts').textContent = bts;
  document.getElementById('outTfb').textContent = tfb;
  document.getElementById('outAccessories').textContent = accessories;
  document.getElementById('outVaf').textContent = vaf;
  document.getElementById('outTlife').textContent = tlife;
  document.getElementById('outP360').textContent = p360;
}

document.getElementById('loadBtn').addEventListener('click', async () => {
  const storeCodeRaw = document.getElementById('storeInput').value.trim();
  const dateVal = document.getElementById('dateInput').value;
  if (!storeCodeRaw || !dateVal) {
    alert('Enter store code (e.g. 2ESP) and a date.');
    return;
  }
  const storeCode = canonicalStoreCode(storeCodeRaw);
  const dateObj = new Date(dateVal);
  const monthStr = dateObj.toISOString().slice(0,7);
  // load monthly data (site published preferred, fallback local)
  const monthly = await loadMonthlyDataForMonth(monthStr);
  // monthly: { daily: {...}, meta: {...} }
  // if daily is remote but meta is null, try fallback meta key in localStorage
  if (!monthly.meta) {
    const metaKey = 'monthly_meta:' + monthStr;
    const metaStr = localStorage.getItem(metaKey);
    if (metaStr) monthly.meta = JSON.parse(metaStr);
  }
  applyToUI(storeCode, dateObj, monthly);
});

// Pre-fill date input to today and register service worker
(function init() {
  const today = new Date();
  document.getElementById('dateInput').value = today.toISOString().slice(0,10);
})();

// Register service worker (baked in)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/app/sw.js').catch(err => {
    console.warn('ServiceWorker registration failed:', err);
  });
}
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  window.deferredPWAPrompt = e;
});
</script>
</body>
</html>
